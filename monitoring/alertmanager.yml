# AlertManagerè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# FX Trading System ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†è¨­å®š

global:
  # SMTPè¨­å®šï¼ˆãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç”¨ï¼‰
  smtp_smarthost: '${EMAIL_SMTP_HOST}:${EMAIL_SMTP_PORT}'
  smtp_from: '${EMAIL_FROM}'
  smtp_auth_username: '${EMAIL_USERNAME}'
  smtp_auth_password: '${EMAIL_PASSWORD}'
  smtp_require_tls: true

# ã‚¢ãƒ©ãƒ¼ãƒˆé‡è¤‡æ’é™¤è¨­å®š
route:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚·ãƒ¼ãƒãƒ¼
  receiver: 'default-receiver'
  
  # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–è¨­å®š
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  
  # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«
  routes:
    # é‡è¦åº¦ critical ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5s
      repeat_interval: 5m
      continue: true

    # å–å¼•ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: trading
      receiver: 'trading-alerts'
      group_wait: 5s
      repeat_interval: 15m
      continue: true

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: database
      receiver: 'database-alerts'
      group_wait: 30s
      repeat_interval: 30m

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 10m

    # ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: system
      receiver: 'system-alerts'
      group_wait: 2m
      repeat_interval: 1h

    # æ©Ÿæ¢°å­¦ç¿’é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: ml
      receiver: 'ml-alerts'
      group_wait: 5m
      repeat_interval: 2h

    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆ
    - match:
        component: backup
      receiver: 'backup-alerts'
      group_wait: 0s
      repeat_interval: 6h

# ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…è¨­å®š
receivers:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå—ä¿¡è€…
  - name: 'default-receiver'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] ä¸€èˆ¬ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          è©³ç´°:
          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ç¢ºèªURL: {{ .ExternalURL }}

  # é‡è¦ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'critical-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: 'ğŸš¨ [FX Trading] ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          âš ï¸ ç·Šæ€¥äº‹æ…‹ãŒç™ºç”Ÿã—ã¾ã—ãŸ âš ï¸

          {{ range .Alerts }}
          ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          èª¬æ˜: {{ .Annotations.description }}
          ç™ºç”Ÿæ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ã™ãã«å¯¾å¿œã—ã¦ãã ã•ã„ã€‚
          ç¢ºèªURL: {{ .ExternalURL }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#fx-trading-alerts'
        title: 'ğŸš¨ ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}
        color: danger
    
    webhook_configs:
      - url: '${DISCORD_WEBHOOK_URL}'
        send_resolved: true

  # å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'trading-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          å–å¼•ã®åœæ­¢ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#fx-trading-alerts'
        title: 'ğŸ’° å–å¼•ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
        color: warning

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'database-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'security-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: 'ğŸ”’ [FX Trading] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#fx-trading-security'
        title: 'ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
        color: danger

  # ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'system-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

  # æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'ml-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] MLã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          æ©Ÿæ¢°å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ãƒ¢ãƒ‡ãƒ«ã®å†å­¦ç¿’ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒ©ãƒ¼ãƒˆå—ä¿¡è€…
  - name: 'backup-alerts'
    email_configs:
      - to: '${EMAIL_TO}'
        subject: '[FX Trading] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}'
        body: |
          ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

          {{ range .Alerts }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          - èª¬æ˜: {{ .Annotations.description }}
          - é‡è¦åº¦: {{ .Labels.severity }}
          - æ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

          ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

# ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶è¨­å®š
inhibit_rules:
  # é‡è¦åº¦ãŒé«˜ã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆã€åŒã˜å¯¾è±¡ã®ä½ã„é‡è¦åº¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # ã‚·ã‚¹ãƒ†ãƒ åœæ­¢æ™‚ã¯ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      severity: '.*'
    equal: ['instance']

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åœæ­¢æ™‚ã¯é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match_re:
      component: 'database'
    equal: ['instance']

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š
templates:
  - '/etc/alertmanager/templates/*.tmpl'