# チケット003: データベース設計・実装

## 概要
FX取引システムに必要な全テーブルの設計と実装を行う。

## 目的
- 取引履歴、価格データ、バックテスト結果等を効率的に管理
- TimescaleDBを活用した時系列データの最適化
- データの整合性とパフォーマンスを確保

## 要件
- 価格データテーブル（TimescaleDB）
- 取引履歴テーブル
- バックテスト結果テーブル
- システム設定テーブル
- ユーザー認証テーブル

## 受け入れ基準
- [ ] 全テーブルのCREATE文作成
- [ ] Alembicによるマイグレーション設定
- [ ] インデックス設計と実装
- [ ] テストデータの投入
- [ ] バックアップ・リストア手順の確認

## 技術仕様

### 主要テーブル設計

#### 1. 価格データテーブル
```sql
CREATE TABLE price_data (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,
    timeframe VARCHAR(5) NOT NULL,
    time TIMESTAMPTZ NOT NULL,
    open DECIMAL(10,5) NOT NULL,
    high DECIMAL(10,5) NOT NULL,
    low DECIMAL(10,5) NOT NULL,
    close DECIMAL(10,5) NOT NULL,
    tick_volume BIGINT,
    spread INT,
    real_volume BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(symbol, timeframe, time)
);

-- TimescaleDBハイパーテーブル
SELECT create_hypertable('price_data', 'time');
CREATE INDEX idx_price_data_symbol_timeframe ON price_data (symbol, timeframe, time DESC);
```

#### 2. 取引履歴テーブル
```sql
CREATE TABLE trades (
    id SERIAL PRIMARY KEY,
    order_id BIGINT UNIQUE,
    symbol VARCHAR(10) NOT NULL,
    order_type VARCHAR(10) NOT NULL, -- BUY, SELL
    entry_time TIMESTAMPTZ NOT NULL,
    entry_price DECIMAL(10,5) NOT NULL,
    exit_time TIMESTAMPTZ,
    exit_price DECIMAL(10,5),
    volume DECIMAL(10,2) NOT NULL,
    profit_loss DECIMAL(10,2),
    commission DECIMAL(10,2),
    swap DECIMAL(10,2),
    stop_loss DECIMAL(10,5),
    take_profit DECIMAL(10,5),
    comment TEXT,
    strategy_name VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_trades_symbol_entry_time ON trades (symbol, entry_time DESC);
CREATE INDEX idx_trades_strategy ON trades (strategy_name, entry_time DESC);
```

#### 3. バックテスト結果テーブル
```sql
CREATE TABLE backtest_results (
    id SERIAL PRIMARY KEY,
    test_id UUID NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    timeframe VARCHAR(5) NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    initial_balance DECIMAL(10,2) NOT NULL,
    final_balance DECIMAL(10,2) NOT NULL,
    total_trades INT NOT NULL,
    winning_trades INT NOT NULL,
    losing_trades INT NOT NULL,
    profit_factor DECIMAL(8,4),
    max_drawdown DECIMAL(8,4),
    max_drawdown_percent DECIMAL(5,2),
    sharpe_ratio DECIMAL(8,4),
    sortino_ratio DECIMAL(8,4),
    calmar_ratio DECIMAL(8,4),
    win_rate DECIMAL(5,2),
    avg_win DECIMAL(10,2),
    avg_loss DECIMAL(10,2),
    largest_win DECIMAL(10,2),
    largest_loss DECIMAL(10,2),
    parameters JSONB NOT NULL,
    equity_curve JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_backtest_test_id ON backtest_results (test_id);
CREATE INDEX idx_backtest_symbol_timeframe ON backtest_results (symbol, timeframe);
CREATE INDEX idx_backtest_created_at ON backtest_results (created_at DESC);
```

#### 4. システム設定テーブル
```sql
CREATE TABLE system_settings (
    id SERIAL PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    key VARCHAR(100) NOT NULL,
    value JSONB NOT NULL,
    description TEXT,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(category, key)
);

-- 初期設定データ
INSERT INTO system_settings (category, key, value, description) VALUES
('risk_management', 'max_risk_per_trade', '20', '1取引あたりの最大リスク(%)'),
('risk_management', 'max_drawdown', '20', '最大ドローダウン(%)'),
('risk_management', 'use_nanpin', 'true', 'ナンピン機能の使用'),
('risk_management', 'nanpin_max_count', '3', 'ナンピン最大回数'),
('trading', 'active_symbol', 'USDJPY', 'アクティブな通貨ペア'),
('trading', 'active_timeframe', 'H1', 'アクティブな時間軸');
```

#### 5. MLモデル管理テーブル
```sql
CREATE TABLE ml_models (
    id SERIAL PRIMARY KEY,
    model_name VARCHAR(100) NOT NULL,
    model_type VARCHAR(50) NOT NULL, -- lightgbm, lstm, dqn
    symbol VARCHAR(10) NOT NULL,
    timeframe VARCHAR(5) NOT NULL,
    version VARCHAR(20) NOT NULL,
    file_path VARCHAR(255) NOT NULL,
    training_period_start DATE NOT NULL,
    training_period_end DATE NOT NULL,
    validation_score DECIMAL(8,4),
    parameters JSONB,
    feature_importance JSONB,
    is_active BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(model_name, symbol, timeframe, version)
);
```

#### 6. 経済指標カレンダーテーブル
```sql
CREATE TABLE economic_calendar (
    id SERIAL PRIMARY KEY,
    event_time TIMESTAMPTZ NOT NULL,
    currency VARCHAR(3) NOT NULL,
    event_name VARCHAR(255) NOT NULL,
    impact VARCHAR(10) NOT NULL, -- low, medium, high
    actual_value VARCHAR(50),
    forecast_value VARCHAR(50),
    previous_value VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_economic_calendar_time ON economic_calendar (event_time);
CREATE INDEX idx_economic_calendar_currency ON economic_calendar (currency, event_time);
```

## マイグレーション管理
```python
# alembic/env.py 設定
# database/migrations/ ディレクトリで管理

# マイグレーション作成
alembic revision --autogenerate -m "Initial tables"

# マイグレーション実行
alembic upgrade head
```

## データ保持期間
- price_data: 5年間
- trades: 永続保存
- backtest_results: 2年間
- economic_calendar: 1年間

## バックアップ戦略
- 日次フルバックアップ
- 重要テーブルのリアルタイムレプリケーション
- WALアーカイブによるポイントインタイムリカバリ

## 見積もり
**2日**

## 依存関係
- チケット001: 環境構築

## 完了条件
- [ ] 全テーブルが正常に作成される
- [ ] インデックスが適切に設定される
- [ ] マイグレーションが正常に動作する
- [ ] テストデータの挿入・取得が可能
- [ ] バックアップ・リストアが動作する