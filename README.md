# FX自動売買システム

XMTradingのMT5とPython、LightGBM機械学習モデルを統合したFX自動売買システムです。

## 目次
- [システム概要](#システム概要)
- [必要要件](#必要要件)
- [インストール手順](#インストール手順)
- [初期設定](#初期設定)
- [アプリケーションの起動](#アプリケーションの起動)
- [使い方](#使い方)
- [トラブルシューティング](#トラブルシューティング)

## システム概要

### 主な機能
- **自動売買**: MT5 APIを通じた自動注文執行
- **機械学習予測**: LightGBMを使用した価格予測
- **バックテスト**: 過去データでの戦略検証
- **時間帯分析**: 最適な取引時間の自動検出
- **リスク管理**: カスタマイズ可能なリスク設定
- **リアルタイム監視**: Web UIでの取引監視

### 対応通貨ペア
- USD/JPY, EUR/JPY, GBP/JPY, AUD/JPY
- NZD/JPY, CAD/JPY, CHF/JPY

## 必要要件

### システム要件
- **OS**: Windows 10/11（64bit）
- **メモリ**: 8GB以上推奨
- **ストレージ**: 10GB以上の空き容量
- **インターネット**: 安定した接続環境

### ソフトウェア要件
- **Python**: 3.9以上
- **Node.js**: 18.0以上
- **PostgreSQL**: 14以上
- **Redis**: 6.0以上
- **MetaTrader 5**: 最新版
- **Git**: 最新版

### XMTrading口座
- MT5対応の取引口座
- APIアクセス許可済み

## インストール手順

### 1. リポジトリのクローン

```bash
git clone https://github.com/MMC-SIDE/FX_A.git
cd FX_A
```

### 2. 自動セットアップ（2つの方法）

#### 方法1: UV版（推奨・高速）
```bash
# UV（高速パッケージマネージャー）を使用
setup_with_uv.bat
```

#### 方法2: 通常版
```bash
# 標準的なpipを使用
setup_no_uv.bat
```

セットアップスクリプトが自動的に：
- Python仮想環境を作成
- 必要なパッケージをインストール
- 設定ファイルのテンプレートを作成

### 3. PostgreSQLのセットアップ

```bash
# PostgreSQLのインストール（公式サイトからダウンロード）
# https://www.postgresql.org/download/windows/

# データベースの作成
psql -U postgres
CREATE DATABASE fx_trading;
CREATE USER fx_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE fx_trading TO fx_user;
\q

# TimescaleDB拡張のインストール
psql -U postgres -d fx_trading < database/timescale_setup.sql
```

### 4. Redisのインストール

```bash
# Redisのダウンロードとインストール
# https://github.com/microsoftarchive/redis/releases

# Redisサーバーの起動
redis-server
```

### 5. データベースマイグレーション

```bash
# 仮想環境を有効化してから実行
call .venv\Scripts\activate  # UV版の場合
# または
call venv\Scripts\activate   # 通常版の場合

# マイグレーションの実行
alembic upgrade head
```

## 初期設定

### 1. MT5認証情報の設定

セットアップスクリプトが`config/mt5_config.json`のテンプレートを作成します。以下の内容を編集してください：

```json
{
  "login": "あなたのMT5ログインID",
  "password": "あなたのMT5パスワード",
  "server": "XMTrading-MT5",
  "timeout": 60000,
  "path": "C:\\Program Files\\MetaTrader 5\\terminal64.exe"
}
```

**重要**: このファイルはGitにコミットしないでください（.gitignoreに登録済み）。

### 2. 環境変数の設定

セットアップスクリプトが`.env`ファイルを作成します。必要に応じて編集してください：

```env
# データベース設定
DATABASE_URL=postgresql://fx_user:your_password@localhost:5432/fx_trading

# Redis設定
REDIS_URL=redis://localhost:6379

# API設定
API_SECRET_KEY=your_secret_key_here

# 取引設定（安全なデフォルト値）
MAX_RISK_PER_TRADE=0.01  # 1%に設定（安全）
MAX_DRAWDOWN=0.05        # 5%に設定（安全）
USE_NANPIN=false         # ナンピング無効（安全）
NANPIN_MAX_COUNT=2
```

### 3. リスク管理設定の確認

セットアップスクリプトは安全なデフォルト値を設定します：

- **設定済みの安全な値**:
  - 1取引あたりの最大リスク: 1%
  - 最大ドローダウン: 5%
  - ナンピング: 無効

必要に応じて`.env`ファイルで調整可能です。

## アプリケーションの起動

### 簡単な起動方法（推奨）

#### UV版を使用する場合:
```bash
# 起動
start_with_uv.bat

# 停止
stop.bat
```

#### 通常版を使用する場合:
```bash
# 起動
start_no_uv.bat

# 停止
stop.bat
```

これらのスクリプトが自動的に：
- Redisサーバーを起動（インストール済みの場合）
- FastAPIバックエンドを起動
- Celeryワーカーを起動
- Next.jsフロントエンドを起動
- ブラウザを自動的に開く

### アプリケーションへのアクセス

起動スクリプトが自動的にブラウザを開きます。手動でアクセスする場合：
- **フロントエンド**: http://localhost:3003
- **バックエンドAPI**: http://localhost:8000/docs

## 使い方

### ステップ1: システムの起動

#### 簡単起動（推奨）
```bash
# バックエンドとフロントエンドを自動起動
start_all.bat
```

または個別起動:
```bash
# バックエンドサーバー起動
start_simple_backend.bat

# フロントエンド起動（別のターミナル）
start_simple_frontend.bat
```

起動後、以下にアクセスできます：
- **フロントエンド**: http://localhost:3003
- **バックエンドAPI**: http://localhost:8000/docs

### ステップ2: 基本操作

#### 1. ホームダッシュボード
http://localhost:3003

**表示される情報**:
- **口座残高**: MT5からリアルタイム取得（例: ¥48,149）
- **有効証拠金**: 現在の証拠金（例: ¥90,658）
- **システムステータス**: MT5接続状態、データベース状態
- **監視通貨ペア**: USDJPY、EURJPY、GBPJPYなど

**操作**:
- MT5接続状態が「未接続」の場合、クリックして再接続
- 「取引制御画面」ボタンで自動売買画面へ移動

#### 2. 自動売買制御画面
http://localhost:3003/trading

**機能**:
- **取引状態監視**: 稼働中/停止中の状態確認
- **口座情報**: リアルタイム残高・証拠金表示
- **リスク管理状態**: ドローダウン、ポジション数、日次損益
- **取引制御**: 開始・停止・緊急停止

**基本操作手順**:
1. **通貨ペア選択**: USDJPY、EURJPY等から選択
2. **時間軸設定**: M1、M5、M15、M30、H1、H4、D1から選択
3. **取引開始**: 「取引開始」ボタンをクリック
4. **監視**: 5秒間隔で自動更新される状態を確認

**緊急時の操作**:
- **緊急停止**: 全取引を即座に停止
- **停止＆決済**: 取引停止と全ポジション決済を同時実行

#### 3. バックテスト機能
http://localhost:3003/backtest

**実行手順**:
1. **通貨ペア選択**: テストする通貨ペア（例: USDJPY）
2. **期間設定**: 
   - 開始日: 例) 2024-01-01
   - 終了日: 例) 2024-12-31
3. **パラメータ設定**:
   - 時間軸: H1（1時間足）推奨
   - 初期残高: 100,000円
   - リスク設定: 2%（デフォルト）
4. **実行**: 「バックテスト開始」ボタンをクリック
5. **結果確認**:
   - 総取引数: 500件以上
   - 勝率: 55%程度
   - プロフィットファクター: 1.2以上推奨
   - 最大ドローダウン: 20%以下推奨

#### 4. 時間帯分析
http://localhost:3003/analysis

**自動分析される項目**:
- **市場セッション分析**:
  - 東京市場（9:00-15:00）: 勝率55%
  - ロンドン市場（16:00-24:00）: 勝率58%  
  - ニューヨーク市場（21:00-6:00）: 勝率60.6%（最適）
- **時間別パフォーマンス**: 24時間の勝率データ
- **曜日別分析**: 月曜〜金曜の傾向

**活用方法**:
- NY市場時間（21:00-6:00）での取引を重視
- 勝率の低い時間帯での取引を避ける

### ステップ3: 実際の取引運用

#### 事前準備チェックリスト
- [ ] MT5ターミナルが起動している
- [ ] インターネット接続が安定している  
- [ ] 十分な証拠金がある（推奨: 10万円以上）
- [ ] リスク設定が適切に設定されている

#### 推奨する運用設定
```
通貨ペア: USDJPY（最も安定）
時間軸: H1（1時間足）
最大リスク: 2%（安全重視）
最大ドローダウン: 20%
ナンピン: ON（最大3回）
取引時間: NY市場時間帯（21:00-6:00）
```

#### 日常の監視項目
1. **朝（9:00）**: 夜間の取引結果確認
2. **夕方（17:00）**: システム状態確認
3. **夜（21:00）**: NY市場開始前の最終チェック

### ステップ4: 高度な機能

#### API直接アクセス
バックエンドAPIに直接アクセスして詳細データを取得:

```bash
# 取引状態確認
curl http://localhost:8000/api/v1/trading/status

# 現在のポジション取得  
curl http://localhost:8000/api/v1/trading/positions

# 口座情報取得
curl http://localhost:8000/api/v1/trading/account-info
```

#### リスク管理の細かい設定
`backend/core/risk_manager.py`で以下を調整可能:
- 最大ポジション数
- 連続損失制限
- 日次損失制限
- トレーリングストップ設定

#### ログ監視
重要なログファイル:
- `logs/app.log`: アプリケーション全般
- `logs/trading.log`: 取引関連
- `logs/error.log`: エラー専用

## 本番環境での運用

### 1. デモ口座でのテスト

**必ず最初はデモ口座で十分なテストを行ってください**

1. XMTradingでデモ口座を開設
2. デモ口座の認証情報を設定
3. 最低2週間のテスト運用

### 2. 本番環境への移行

```bash
# 本番用の設定ファイルをコピー
copy .env.prod.example .env.prod

# 本番環境のビルド
cd frontend
npm run build

# Docker Composeで起動（推奨）
docker-compose -f docker-compose.prod.yml up -d
```

### 3. 監視とメンテナンス

- **ログの確認**: `logs/`ディレクトリ内のログを定期的に確認
- **バックアップ**: データベースの定期バックアップを設定
- **モデルの再学習**: 月に1回程度、機械学習モデルを再学習

## バッチファイル一覧

| ファイル名 | 説明 |
|------------|------|
| `setup_with_uv.bat` | UV（高速パッケージマネージャー）を使用したセットアップ |
| `setup_no_uv.bat` | 通常のpipを使用したセットアップ |
| `start_with_uv.bat` | UV環境でシステムを起動 |
| `start_no_uv.bat` | 通常環境でシステムを起動 |
| `stop.bat` | すべてのサービスを停止 |

## トラブルシューティング

### MT5に接続できない

1. MT5が起動していることを確認
2. `config/mt5_config.json`の設定を確認
3. ファイアウォール設定を確認
4. MT5のAPIアクセスが有効か確認

### データベース接続エラー

1. PostgreSQLサービスが起動しているか確認
```bash
# サービスの状態確認
sc query postgresql
```

2. 接続情報が正しいか確認
3. データベースが作成されているか確認

### Python 3.12でのインストールエラー

Python 3.12では一部のパッケージに互換性問題があります。以下の対処法：

1. UV版のセットアップを使用（推奨）
```bash
setup_with_uv.bat
```

2. または、Python 3.11をインストールして使用

### フロントエンドが表示されない

1. Node.jsのバージョンを確認（18以上）
```bash
node --version
```

2. 依存関係を再インストール
```bash
cd frontend
rmdir /s /q node_modules
npm install
```

### 取引が実行されない

1. MT5の取引が有効になっているか確認
2. 十分な証拠金があるか確認
3. 取引時間内か確認
4. ログファイルでエラーを確認

## セキュリティ上の注意

1. **認証情報の管理**
   - `mt5_config.json`は絶対にGitにコミットしない
   - 環境変数は`.env`ファイルで管理
   - 本番環境では環境変数を暗号化

2. **アクセス制限**
   - Web UIには必ず認証を設定
   - APIエンドポイントにレート制限を設定
   - 本番環境ではHTTPSを使用

3. **定期的な更新**
   - セキュリティパッチの適用
   - 依存関係の更新

## サポート

### ドキュメント
- 詳細な技術仕様: `fx_trading_system_spec.md`
- 要件定義: `requirements_definition.md`
- 開発チケット: `doc/`ディレクトリ

### 問題報告
GitHubのIssuesで報告してください：
https://github.com/MMC-SIDE/FX_A/issues

## ライセンス

このプロジェクトは個人使用を目的としています。商用利用の際はご相談ください。

## 重要な使用上の注意

### 取引開始前の必須確認事項
1. **MT5ターミナルの起動**: 必ずMT5が起動していることを確認
2. **デモ口座でのテスト**: 最初は必ずデモ口座で動作確認
3. **リスク設定の確認**: 初期設定では安全な2%に設定されています
4. **インターネット接続**: 安定した接続環境を確保

### 現在動作確認済みの機能
✅ **完全実装・動作確認済み**:
- MT5リアル口座接続（Login: 72009058、残高: ¥48,149）
- LightGBM機械学習予測モデル
- 包括的バックテストシステム（500+サンプル取引、勝率55%）
- 時間帯分析（NY市場が最適: 60.6%勝率）
- 自動売買エンジン（ナンピン、トレーリングストップ対応）
- リスク管理システム（ドローダウン監視、緊急停止）
- Web取引制御画面（リアルタイム監視）
- 全API動作確認完了

### 取引システムの特徴
- **対応通貨ペア**: USDJPY、EURJPY、GBPJPY、AUDJPY、NZDJPY、CADJPY、CHFJPY
- **推奨時間軸**: H1（1時間足）
- **最適取引時間**: NY市場時間帯（21:00-6:00 JST）
- **安全な初期設定**: 最大リスク2%、最大ドローダウン20%
- **高度なリスク管理**: 連続損失制限、日次損失制限、緊急停止機能

### サポートされている操作
- **自動売買の開始・停止**: Webインターフェースから簡単操作
- **リアルタイム監視**: 5秒間隔での状態更新
- **緊急停止**: 即座に全取引を停止
- **ポジション管理**: 個別・一括でのポジション決済
- **バックテスト**: 過去データでの戦略検証
- **時間帯分析**: 最適な取引時間の自動検出

## 免責事項

**重要**: 
- FX取引は元本が保証されていません
- 過去の成績は将来の結果を保証しません
- 実際の取引は自己責任で行ってください
- システムエラーによる損失の責任は負いかねます
- 必ず少額・デモ口座から開始してください

---

最終更新: 2025年8月15日